---
title: "Taxon-Taxon Associations: Co-occurrence"
author: "Hanna Berman"
date: "8/8/2019"
output: html_document
---

Assess *Gardnerella* clade and *Lactobacillus spp.* co-occurrence using a hypergeometric null of the probability of *j* co-occurrences   $$P_{j}=\frac{\binom{N}{j}\times\binom{N-N_1}{N_2-j}}{\binom{N}{N-2}}$$   
Where $N =$ the numner of sites surveyed, $N_1=$ the number of sites where taxon 1 occurrs, and $N_2=$ the number of sites where taxon 2 occurrs.  

# Set up
Packages
```{r}
library(tidyverse)
library(cooccur)
```

File paths
```{r}
#metadata
sgDF <- file.path("..", "..", "shotgunMetadata.tsv") %>%
  read_tsv() %>%
  mutate(SampleID=as.character(SampleID))

#metaphlan data
load("metaphlanAbundances.Rdata")
```

Organize data frame
```{r}
DF <- sgDF %>%
  select(SampleID, SubjectID, Cohort, GDcoll) %>%
  left_join(mDF[,c("SampleID", "Gardnerella_vaginalis")], by="SampleID") %>%
  left_join(mDFG[,c("SampleID",
                    "Gardnerella_vaginalis_C1", 
                    "Gardnerella_vaginalis_C2", 
                    "Gardnerella_vaginalis_C3", 
                    "Gardnerella_vaginalis_C4",
                    "Gardnerella_vaginalis_C5",
                    "Gardnerella_vaginalis_C6",
                    "Lactobacillus_crispatus", 
                    "Lactobacillus_gasseri",
                    "Lactobacillus_jensenii", 
                    "Lactobacillus_iners", 
                    "Atopobium_vaginae", 
                    "Mycoplasma_hominis",
                    "Prevotella_bivia",
                    "Ureaplasma_parvum")],
            by="SampleID") %>%
  mutate(SampleID=as.character(SampleID),
         SubjectID=as.character(SubjectID),
         GDcoll=as.character(GDcoll))

DFpa <- DF %>% #presence, absence DF
  mutate_if(is.numeric, 
            ~case_when(.x>0~1,
                       .x==0~0)) %>%
  mutate(GDcoll=as.numeric(as.character(GDcoll)))

subsetSamples <- read_lines(file.path("..", "..", "sampleSubset.txt"))
```

Define the two groups of taxa pairs to assess: (six *Gardnerella vaginalis* clades and four *Lactobacillus* species, and total *Gardnerella vaginalis* and four *Lactobacilllus* species).  
```{r}
# Taxa groups:
gardnerellaClades <- c("Gardnerella_vaginalis_C1", "Gardnerella_vaginalis_C2", "Gardnerella_vaginalis_C3", "Gardnerella_vaginalis_C4", "Gardnerella_vaginalis_C5", "Gardnerella_vaginalis_C6")
cladesLactos <- c("Gardnerella_vaginalis_C1", "Gardnerella_vaginalis_C2", "Gardnerella_vaginalis_C3", "Gardnerella_vaginalis_C4", "Gardnerella_vaginalis_C5", "Gardnerella_vaginalis_C6", "Lactobacillus_crispatus", "Lactobacillus_gasseri", "Lactobacillus_iners", "Lactobacillus_jensenii")
allGardLactos <- c("Gardnerella_vaginalis", "Lactobacillus_crispatus", "Lactobacillus_gasseri", "Lactobacillus_jensenii", "Lactobacillus_iners")
cladesSpecies <- c("Gardnerella_vaginalis_C1", "Gardnerella_vaginalis_C2", "Gardnerella_vaginalis_C3", "Gardnerella_vaginalis_C4", "Gardnerella_vaginalis_C5", "Gardnerella_vaginalis_C6", "Lactobacillus_crispatus", "Lactobacillus_gasseri", "Lactobacillus_iners", "Lactobacillus_jensenii", "Atopobium_vaginae", "Mycoplasma_hominis", "Prevotella_bivia", "Ureaplasma_parvum")
allGardSpecies <- c("Gardnerella_vaginalis", "Lactobacillus_crispatus", "Lactobacillus_gasseri", "Lactobacillus_iners", "Lactobacillus_jensenii", "Atopobium_vaginae", "Mycoplasma_hominis", "Prevotella_bivia", "Ureaplasma_parvum")
```

# Co-occurrence
Probabilistic assessment of cooccurrence performed using the `cooccur` R package  
Griffith D, Veech J, Marsh C. cooccur: Probabilistic Species Co-Occurrence Analysis in R. Journal of Statistical Software, Code Snippets. 2016;69(2):1–17.  
Based on:  
Veech JA. A probabilistic model for analysing species co-occurrence. Peres-Neto P, editor. Glob Ecol Biogeogr. 2013 Feb 22;22(2):252–60.

Use a hypergeometric distribution to test if co-occurrence occurs more or less than expected.  

$p$ value for testing whether the observed number of co-occurrences ($Q_{obs}$) is less than expected can be calculated as the sum of the probability of seeing the two taxa co-occurr less than ($P_{lt}$) and equal to ($P_{et}$) $Q_{obs}$.

$p$ value for testing whether the observed number of co-occurrences ($Q_{obs}$) is greater than expected can be calculated as the sum of the probability of seeing the two taxa co-occurr greater than ($P_{gt}$) and equal to ($P_{et}$) $Q_{obs}$.

Effect size is the difference between observed and expected co-occurrences, normalized to the number of sites.

## Define functions
Make a function to perform and plot analyses for convenience.  
```{r}
cooccurr_analyses <- function(cohort, samples, organisms){  
  x <- DFpa %>%
    filter(Cohort==cohort,
          is.element(SampleID, samples)) %>%
    select(organisms) %>%
    select_if(~sum(.x)!=0) %>%
    t() %>%
    as.matrix() %>%
    cooccur(., type="spp_site", spp_names=TRUE, prob="hyper", eff_standard=TRUE, thresh=FALSE)
  
  x0 <- x$results %>%
    select(sp1_name, sp2_name, obs_cooccur, exp_cooccur, p_lt, p_gt) %>%
    mutate(sp1_name=as.character(sp1_name),
           sp2_name=as.character(sp2_name))
  
  x1 <- x %>%
    effect.sizes() %>%
    dplyr::rename(sp1_name=sp1,
                  sp2_name=sp2) %>%
    mutate(sp1_name=as.character(sp1_name),
           sp2_name=as.character(sp2_name)) %>%
    left_join(x0, by=c("sp1_name", "sp2_name"))

  #make table to add missing sp1 and sp2's
  x2 <- x1 %>% 
    dplyr::rename(sp1_name=sp2_name,
                  sp2_name=sp1_name) 
  #make full table  
  x3 <- x1 %>% 
    full_join(x2, by=colnames(x1)) %>%
    unique.data.frame()
  
  # removing redundant iformation:
  x4 <- x3 %>%
    select(sp1_name, sp2_name, effects) %>%
    spread(sp2_name, effects) 
  x5 <- x4 %>% # remove sp1 names column and get upper triangle
    select(-sp1_name) %>%
    as.matrix()
  x5[upper.tri(x5)] <- NA
  
  #add sp1 names column back and other columns
  x6 <- x5 %>% 
    as.data.frame() %>%
    mutate(sp1_name=x4$sp1_name) %>%
    select(sp1_name, everything()) %>% #rearrange columns
    gather("sp2_name", "effects", c(2:ncol(.))) %>%
    left_join(x3[,c("sp1_name", "sp2_name", "p_lt", "p_gt")], by=c("sp1_name", "sp2_name")) %>%
    mutate(p_lt=case_when(is.na(effects)==TRUE~1,
                          is.na(effects)==FALSE~p_lt),
           p_gt=case_when(is.na(effects)==TRUE~1,
                          is.na(effects)==FALSE~p_gt),
      pvalue=case_when(p_lt>0.01&p_gt>0.01~"",
                            p_lt<=0.01&p_lt>0.001~"*",
                            p_gt<=0.01&p_gt>0.001~"*",
                            p_lt<=0.001&p_lt>0.0005~"**",
                            p_gt<=0.001&p_gt>0.0005~"**",
                            p_lt<=0.0005&p_lt>0.0001~"***",
                            p_gt<=0.0005&p_gt>0.0001~"***",
                            p_lt<=0.0001~"****",
                            p_gt<=0.0001~"****"))
  
  samples <- ifelse(length(samples)==length(subsetSamples), "Sample Subset", "All Samples")
  title <- ifelse(length(organisms)==length(cladesSpecies), "Co-occurrence of G. vaginalis clades and key species", "Co-occurrence of total G. vaginalis and key species")
  x6$sp1_name <- factor(x6$sp1_name, levels=organisms[order(organisms)]) #order x axis
  x6$sp2_name <-  factor(x6$sp2_name, levels=organisms[rev(order(organisms))]) #order y axis (reverse of x axis)

    plot <- ggplot(x6, aes(x=sp1_name, y=sp2_name, fill=effects, label=pvalue)) +
    geom_tile() +
    geom_text()+
    scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0) +
    scale_x_discrete(position="top") +
    theme(axis.text.x = element_text(angle = 45, hjust=0)) +
    labs(title=title, subtitle = paste0(cohort, ": ", samples), x=NULL, y=NULL)
  return(list(Cooccur_summary=summary(x), 
              Cooccur_results=x$results, 
              Heatmap=plot))
}
```

 
In blue-red heat maps, color is the effect size (difference between observed and expected co-occurrences normalized by dividing by number of sites), asterisks reflect p values:  
$p≤0.01: *$  
$p≤0.001: **$  
$p≤0.0005: ***$  
$p≤0.0001: ****$

Note: With family-wise error rate of $\alpha = 0.05$, with 91 pair comparisons (six *Gardnerella vaginalis* clades and eight "key" vaginal microbiome species), adjusted $\alpha$ = $0.0005$, and with 36 pairs, (total *Gardnerella vaginalis* and eight "key" vaginal microbiome species) the adjusted $\alpha$ = 0.001. 

Analyses were performed on all samples from each cohort, and then a subset of one sample per subject randomly selected from the second trimester. 
Stanford: $N=62$ samples total from 20 subjects, subset $N=20$ samples.
UAB: $N=45$ samples from 15 subjects, subset $N=14$ samples (subject 40047 did not have samples in the second trimester).

## Stanford
### All Samples
```{r, warning=FALSE}
cooccurr_analyses("Stanford", sgDF$SampleID, cladesSpecies)
cooccurr_analyses("Stanford", sgDF$SampleID, allGardSpecies)
```

### Sample Subset
```{r, warning=FALSE}
cooccurr_analyses("Stanford", subsetSamples, cladesSpecies)
cooccurr_analyses("Stanford", subsetSamples, allGardSpecies)
```

## UAB
### All Samples
```{r, warning=FALSE}
cooccurr_analyses("UAB", sgDF$SampleID, cladesSpecies)
cooccurr_analyses("UAB", sgDF$SampleID, allGardSpecies)
```

### Sample Subset
```{r, warning=FALSE}
cooccurr_analyses("UAB", subsetSamples, cladesSpecies)
cooccurr_analyses("UAB", subsetSamples, allGardSpecies)
```
Note: no *L. crispatus* in any of the randomly selected subset samples in the UAB cohort. All of these samples have C1 and total Gard

Overall, results support previous findings that Gv less associated with Lactobaillus spp., whereas Gv clades and other BV-associated taxa may cooccurr. C1 appears co-occur more strongly with *Atopobium vaginae* in Stanford cohort compared to other Clades.
C5 may co-occur with L. iners (small trend found in both cohorts.) Not significant, but consistently greatest effects in exclusion with C1, C2 and C5 and Lactos (except C5 and L. iners). However, this method has low power with few sample sites (Veech, 2013), which may affect the ability to interpret results.

# Presence-Absence in Samples
## Presence-Absence in all samples
```{r, fig.height=4, fig.width=6}
DFpa %>%
  dplyr::rename(C1=Gardnerella_vaginalis_C1,
                C2=Gardnerella_vaginalis_C2,
                C3=Gardnerella_vaginalis_C3,
                C4=Gardnerella_vaginalis_C4,
                C5=Gardnerella_vaginalis_C5,
                C6=Gardnerella_vaginalis_C6,
                G_vaginalis=Gardnerella_vaginalis,
                A_vaginae=Atopobium_vaginae,
                L_crispatus=Lactobacillus_crispatus,
                L_gasseri=Lactobacillus_gasseri,
                L_iners=Lactobacillus_iners,
                L_jensenii=Lactobacillus_jensenii,
                P_bivia=Prevotella_bivia,
                U_parvum=Ureaplasma_parvum,
                M_hominis=Mycoplasma_hominis) %>%
  gather("Organism", "PresAbs", 5:ncol(.)) %>%
  mutate(PresAbs=case_when(PresAbs==0~"Abs",
                           PresAbs==1~"Pres")) %>%
  ggplot(aes(x=PresAbs)) +
    geom_bar() +
    facet_grid(Cohort~Organism)
```

## Presence-Absence in subset samples
```{r, fig.height=4, fig.width=6}
DFpa %>%
  filter(is.element(SampleID, subsetSamples)) %>%
  dplyr::rename(C1=Gardnerella_vaginalis_C1,
                C2=Gardnerella_vaginalis_C2,
                C3=Gardnerella_vaginalis_C3,
                C4=Gardnerella_vaginalis_C4,
                C5=Gardnerella_vaginalis_C5,
                C6=Gardnerella_vaginalis_C6,
                total_Gard=Gardnerella_vaginalis,
                A_vaginae=Atopobium_vaginae,
                L_crispatus=Lactobacillus_crispatus,
                L_gasseri=Lactobacillus_gasseri,
                L_iners=Lactobacillus_iners,
                L_jensenii=Lactobacillus_jensenii,
                P_bivia=Prevotella_bivia,
                U_parvum=Ureaplasma_parvum,
                M_hominis=Mycoplasma_hominis) %>%
  gather("Organism", "PresAbs", 5:ncol(.)) %>%
  mutate(PresAbs=case_when(PresAbs==0~"Abs",
                           PresAbs==1~"Pres")) %>%
  ggplot(aes(x=PresAbs)) +
    geom_bar() +
    facet_grid(Cohort~Organism)
```

Looking at other taxa to possibly include
```{r}
testDists <- mDFG %>%
  select(SampleID, contains("Ureaplasma"), contains("Trich")) %>%
  mutate_if(is.numeric, ~case_when(.x==0~"Absent",
                                   .x>0~"Present")) %>%
  left_join(sgDF[,c("SampleID", "Cohort")], by="SampleID") %>%
  gather("Organism", "PresAbs", c("Ureaplasma_parvum", "Ureaplasma_unclassified", "Ureaplasma_urealyticum", "Trichomonas_vaginalis"))
colnames(testDists)

ggplot(data=testDists, aes(x=PresAbs)) +
  geom_bar() +
  facet_grid(Cohort~Organism)
```

# Session Info
```{r}
sessionInfo() 
```